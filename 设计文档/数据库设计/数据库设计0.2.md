# Qt6音频处理与播放软件数据库设计文档 v0.2

## 1. 项目概述

### 1.1 设计目标
本版本基于实际项目代码实现，采用现代化的Qt6/C++17架构设计，注重性能优化、内存管理和代码质量。

### 1.2 技术栈
- **数据库**: SQLite 3.x (嵌入式数据库)
- **开发框架**: Qt6.5.3 + C++17
- **架构模式**: 分层架构 + 依赖注入 + RAII
- **设计模式**: 单例模式、工厂模式、观察者模式

## 2. 架构设计

### 2.1 分层架构
```
┌─────────────────┐
│   表现层 (UI)    │  ← 用户界面、控件
├─────────────────┤
│   业务层 (Core)  │  ← 业务逻辑、管理器
├─────────────────┤
│   数据层 (DAO)   │  ← 数据访问对象
├─────────────────┤
│   数据库层       │  ← SQLite数据库
└─────────────────┘
```

### 2.2 核心组件
- **DatabaseManager**: 数据库连接管理器（单例模式）
- **SongDao**: 歌曲数据访问对象
- **TagDAO**: 标签数据访问对象
- **LogDao**: 日志数据访问对象
- **DatabaseTransaction**: RAII事务管理

## 3. 数据库设计

### 3.1 数据库配置
- **连接模式**: WAL (Write-Ahead Logging)
- **外键约束**: 启用
- **同步模式**: NORMAL
- **数据文件**: musicplayer.db

### 3.2 核心数据表

#### 3.2.1 歌曲表 (songs)
存储音频文件的完整信息和元数据

**主要字段**:
- `id`: 主键，自增
- `file_path`: 文件完整路径（唯一索引）
- `title`, `artist`, `album`: 基本音乐信息
- `duration`, `file_size`, `bit_rate`: 技术参数
- `play_count`, `last_played_time`: 播放统计
- `is_favorite`, `is_available`: 状态标记
- `created_at`, `updated_at`: 时间戳

**性能优化**:
- 文件路径、标题、艺术家、专辑建立索引
- 播放次数、收藏状态建立索引

#### 3.2.2 标签表 (tags)
管理音乐分类标签系统

**主要字段**:
- `id`: 主键，自增
- `name`: 标签名称（唯一索引）
- `description`: 标签描述
- `color`: 标签颜色（默认#3498db）
- `tag_type`: 标签类型（0=用户标签，1=系统标签）
- `is_system`, `is_deletable`: 系统属性
- `sort_order`: 排序序号
- `song_count`: 关联歌曲数量

**系统标签**:
- 我的歌曲：所有歌曲的默认标签
- 我的收藏：收藏的歌曲
- 最近播放：最近播放的歌曲

#### 3.2.3 日志表系统

**错误日志表 (error_logs)**:
- 记录应用程序错误信息
- 包含堆栈跟踪、系统信息
- 支持多线程环境

**系统日志表 (system_logs)**:
- 记录系统运行状态
- 性能监控数据
- 操作审计信息

### 3.3 索引策略

#### 3.3.1 查询优化索引
- **歌曲表**: file_path, title, artist, album, date_added, play_count
- **标签表**: name, tag_type, sort_order
- **日志表**: timestamp, level, category, thread_id

#### 3.3.2 复合索引
- 根据实际查询模式动态优化
- 避免过度索引影响写入性能

## 4. 数据访问层设计

### 4.1 DatabaseManager 设计

**核心特性**:
- 线程安全的单例模式
- 自动连接管理和错误处理
- 支持事务管理
- WAL模式优化并发性能

**关键方法**:
- `initialize()`: 数据库初始化
- `beginTransaction()`: 开始事务
- `commitTransaction()`: 提交事务
- `rollbackTransaction()`: 回滚事务

### 4.2 DAO模式实现

**SongDao特性**:
- 完整的CRUD操作
- 批量操作支持
- 复杂查询封装
- 结果集映射

**TagDAO特性**:
- 系统标签保护机制
- 标签关联管理
- 统计信息维护

### 4.3 数据模型设计

**Song模型**:
- 完整的属性封装
- JSON序列化支持
- 数据验证机制
- 格式化显示方法

**Tag模型**:
- 类型安全的枚举
- 系统标签工厂方法
- 权限控制逻辑

## 5. 性能优化策略

### 5.1 内存管理
- **对象池模式**: 复用频繁创建的对象
- **智能指针**: 自动内存管理
- **延迟加载**: 按需加载数据
- **LRU缓存**: 热点数据缓存

### 5.2 查询优化
- **预编译语句**: 提高查询效率
- **批量操作**: 减少数据库交互
- **分页查询**: 处理大数据集
- **索引优化**: 基于查询模式优化

### 5.3 并发控制
- **WAL模式**: 提高读写并发性
- **连接池**: 管理数据库连接
- **事务隔离**: 保证数据一致性

## 6. 错误处理与事务管理

### 6.1 Result模式
- 类型安全的错误处理
- 函数式编程支持
- 链式操作能力

### 6.2 RAII事务管理
- 自动事务生命周期管理
- 异常安全保证
- 嵌套事务支持

### 6.3 结构化日志
- 多级别日志记录
- JSON格式输出
- 日志轮转机制
- 性能监控集成

## 7. 配置与国际化

### 7.1 配置管理
- **TagConfiguration**: 标签相关配置
- **常量集中管理**: Constants命名空间
- **设置持久化**: QSettings集成

### 7.2 国际化支持
- **TagStrings**: 多语言字符串管理
- **动态语言切换**: 运行时切换
- **格式化工具**: 时间、大小格式化

## 8. 测试策略

### 8.1 单元测试
- **TestTagManager**: 标签管理器测试
- **MockTagManager**: 模拟对象
- **边界条件测试**: 异常情况覆盖

### 8.2 集成测试
- 数据库操作测试
- 事务完整性测试
- 并发安全测试

## 9. 安全性与可靠性

### 9.1 数据安全
- **参数化查询**: 防止SQL注入
- **输入验证**: 数据完整性检查
- **权限控制**: 系统标签保护

### 9.2 异常恢复
- **自动重连**: 连接断开恢复
- **数据备份**: 定期备份机制
- **完整性检查**: 数据一致性验证

## 10. 扩展性设计

### 10.1 插件架构
- 预留扩展接口
- 动态加载机制
- 配置驱动扩展

### 10.2 版本管理
- 数据库版本控制
- 平滑升级机制
- 向后兼容性

## 11. 开发工具与规范

### 11.1 构建系统
- **CMake**: 现代化构建系统
- **代码格式化**: clang-format
- **静态分析**: clang-tidy

### 11.2 代码质量
- **SOLID原则**: 面向对象设计
- **现代C++**: C++17特性应用
- **Qt最佳实践**: 信号槽、元对象系统

## 12. 性能指标

### 12.1 目标指标
- **启动时间**: < 2秒
- **内存使用**: < 100MB
- **查询响应**: < 100ms
- **缓存命中率**: > 80%

### 12.2 监控机制
- 性能计数器
- 内存使用监控
- 查询性能分析

---

**版本**: 0.2  
**基于**: 实际项目代码实现  
**创建日期**: 2025年1月  
**技术栈**: Qt6.5.3 + C++17 + SQLite  
**架构**: 现代化分层架构 + 优化模式