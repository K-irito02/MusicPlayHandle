# æ’­æ”¾ä¸æš‚åœä¸å¯æ§é—®é¢˜ - è§£å†³æ–¹æ¡ˆæ–‡æ¡£

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

éŸ³ä¹æ’­æ”¾å™¨çš„æ’­æ”¾/æš‚åœæŒ‰é’®å‡ºç°ä¸å¯æ§é—®é¢˜ï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š
- æ’­æ”¾æŒ‰é’®ç‚¹å‡»åæ— æ³•æ­£ç¡®å“åº”
- æ’­æ”¾çŠ¶æ€åˆ‡æ¢å¼‚å¸¸
- éŸ³é¢‘å¼•æ“çŠ¶æ€ç®¡ç†æ··ä¹±

## ğŸ” é—®é¢˜åˆ†æ

### æ ¸å¿ƒé—®é¢˜
1. **é‡å¤ä¿¡å·è¿æ¥**ï¼šæ’­æ”¾æ§åˆ¶æŒ‰é’®å­˜åœ¨é‡å¤çš„ä¿¡å·è¿æ¥
2. **AudioEngineçŠ¶æ€ç®¡ç†**ï¼šéŸ³é¢‘å¼•æ“çŠ¶æ€è½¬æ¢é€»è¾‘ä¸å®Œå–„
3. **æ’­æ”¾åˆ—è¡¨éªŒè¯**ï¼šç¼ºå°‘å¯¹æ’­æ”¾åˆ—è¡¨å’Œå½“å‰ç´¢å¼•çš„æœ‰æ•ˆæ€§æ£€æŸ¥
4. **é”™è¯¯å¤„ç†ä¸è¶³**ï¼šç¼ºå°‘å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤é‡å¤ä¿¡å·è¿æ¥é—®é¢˜

#### MainWindowControllerä¸­çš„ä¿®å¤
```cpp
void MainWindowController::onPlayButtonClicked()
{
    qDebug() << "[æ’­æ”¾æŒ‰é’®] æ’­æ”¾/æš‚åœæŒ‰é’®è¢«ç‚¹å‡»";
    qDebug() << "[æ’­æ”¾æŒ‰é’®] m_audioEngineæŒ‡é’ˆ:" << m_audioEngine;
    
    if (!m_audioEngine) {
        qDebug() << "[æ’­æ”¾æŒ‰é’®] AudioEngineæœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è·å–";
        m_audioEngine = AudioEngine::instance();
        if (!m_audioEngine) {
            qDebug() << "[æ’­æ”¾æŒ‰é’®] é‡æ–°è·å–AudioEngineå¤±è´¥";
            updateStatusBar("éŸ³é¢‘å¼•æ“æœªå°±ç»ª", 2000);
            return;
        }
        qDebug() << "[æ’­æ”¾æŒ‰é’®] é‡æ–°è·å–AudioEngineæˆåŠŸ:" << m_audioEngine;
    }
    
    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    m_audioEngine->debugAudioState();
    
    AudioTypes::AudioState currentState = m_audioEngine->state();
    int playlistSize = m_audioEngine->playlist().size();
    int currentIndex = m_audioEngine->currentIndex();
    
    qDebug() << "[æ’­æ”¾æŒ‰é’®] å½“å‰éŸ³é¢‘çŠ¶æ€:" << static_cast<int>(currentState);
    qDebug() << "[æ’­æ”¾æŒ‰é’®] å½“å‰æ’­æ”¾åˆ—è¡¨å¤§å°:" << playlistSize;
    qDebug() << "[æ’­æ”¾æŒ‰é’®] å½“å‰æ’­æ”¾ç´¢å¼•:" << currentIndex;
    qDebug() << "[æ’­æ”¾æŒ‰é’®] å½“å‰æ­Œæ›²:" << (m_audioEngine->currentSong().isValid() ? m_audioEngine->currentSong().filePath() : "æ— æ•ˆæ­Œæ›²");
    
    // é¦–å…ˆæ£€æŸ¥æ’­æ”¾åˆ—è¡¨æ˜¯å¦ä¸ºç©ºæˆ–ç´¢å¼•æ— æ•ˆ
    if (playlistSize == 0 || currentIndex < 0) {
        qDebug() << "[æ’­æ”¾æŒ‰é’®] æ’­æ”¾åˆ—è¡¨ä¸ºç©ºæˆ–ç´¢å¼•æ— æ•ˆï¼Œå¼€å§‹æ–°æ’­æ”¾";
        startNewPlayback();
        return;
    }
    
    // æ’­æ”¾åˆ—è¡¨ä¸ä¸ºç©ºæ—¶çš„æ’­æ”¾/æš‚åœé€»è¾‘
    switch (currentState) {
        case AudioTypes::AudioState::Playing:
            qDebug() << "[æ’­æ”¾æŒ‰é’®] æ­£åœ¨æ’­æ”¾ï¼Œæ‰§è¡Œæš‚åœ";
            m_audioEngine->pause();
            break;
            
        case AudioTypes::AudioState::Paused:
            qDebug() << "[æ’­æ”¾æŒ‰é’®] å·²æš‚åœï¼Œæ¢å¤æ’­æ”¾";
            m_audioEngine->play();
            break;
            
        case AudioTypes::AudioState::Loading:
            qDebug() << "[æ’­æ”¾æŒ‰é’®] æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…å®Œæˆ";
            updateStatusBar("æ­£åœ¨åŠ è½½åª’ä½“æ–‡ä»¶...", 2000);
            break;
            
        case AudioTypes::AudioState::Error:
            qDebug() << "[æ’­æ”¾æŒ‰é’®] æ’­æ”¾å‡ºé”™ï¼Œå°è¯•é‡æ–°æ’­æ”¾";
            m_audioEngine->play();
            break;
            
        default:
            qDebug() << "[æ’­æ”¾æŒ‰é’®] å…¶ä»–çŠ¶æ€ï¼Œå¼€å§‹æ’­æ”¾";
            m_audioEngine->play();
            break;
    }
    
    // æ“ä½œåå†æ¬¡è°ƒè¯•
    QTimer::singleShot(100, [this]() {
        if (m_audioEngine) {
            qDebug() << "[æ’­æ”¾æŒ‰é’®] æ“ä½œåçš„çŠ¶æ€:";
            m_audioEngine->debugAudioState();
        }
    });
}
```

### 2. AudioEngineå•ä¾‹æ¨¡å¼å®ç°

#### å•ä¾‹è·å–æ–¹æ³•
```cpp
AudioEngine* AudioEngine::instance()
{
    QMutexLocker locker(&m_instanceMutex);
    if (!m_instance) {
        m_instance = new AudioEngine();
        qDebug() << "[æ’æŸ¥] AudioEngine::instance() åˆ›å»ºå•ä¾‹:" << m_instance;
    } else {
        qDebug() << "[æ’æŸ¥] AudioEngine::instance() è¿”å›å·²å­˜åœ¨å•ä¾‹:" << m_instance;
    }
    return m_instance;
}
```

#### æ’­æ”¾æ–¹æ³•å®ç°
```cpp
void AudioEngine::play()
{
    qDebug() << "[AudioEngine::play] å¼€å§‹æ‰§è¡Œæ’­æ”¾æ–¹æ³•";
    
    if (!m_player) {
        qDebug() << "[AudioEngine::play] é”™è¯¯ï¼šæ’­æ”¾å™¨æœªåˆå§‹åŒ–";
        logError("æ’­æ”¾å™¨æœªåˆå§‹åŒ–");
        return;
    }
    
    try {
        QMutexLocker locker(&m_mutex);
        
        // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨å’Œå½“å‰ç´¢å¼•
        if (m_playlist.isEmpty()) {
            qDebug() << "[AudioEngine::play] æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾";
            logError("æ’­æ”¾åˆ—è¡¨ä¸ºç©º");
            return;
        }
        
        if (m_currentIndex < 0 || m_currentIndex >= m_playlist.size()) {
            qDebug() << "[AudioEngine::play] å½“å‰ç´¢å¼•æ— æ•ˆ:" << m_currentIndex;
            logError("å½“å‰ç´¢å¼•æ— æ•ˆ");
            return;
        }
        
        Song song = m_playlist[m_currentIndex];
        if (!song.isValid()) {
            qDebug() << "[AudioEngine::play] å½“å‰æ­Œæ›²æ— æ•ˆ";
            logError("å½“å‰æ­Œæ›²æ— æ•ˆ");
            return;
        }
        
        QMediaPlayer::PlaybackState playerState = m_player->playbackState();
        qDebug() << "[AudioEngine::play] å½“å‰QMediaPlayerçŠ¶æ€:" << playerState;
        
        // å¦‚æœæ’­æ”¾å™¨å¤„äºåœæ­¢çŠ¶æ€ï¼Œéœ€è¦é‡æ–°åŠ è½½åª’ä½“
        if (playerState == QMediaPlayer::StoppedState) {
            qDebug() << "[AudioEngine::play] æ’­æ”¾å™¨å¤„äºåœæ­¢çŠ¶æ€ï¼Œé‡æ–°åŠ è½½åª’ä½“";
            loadMedia(song.filePath());
            m_player->play();
            m_state = AudioTypes::AudioState::Playing;
            m_userPaused = false;
            emit stateChanged(m_state);
            
            if (m_positionTimer) {
                m_positionTimer->start();
            }
            
            logPlaybackEvent("å¼€å§‹æ’­æ”¾", song.title());
            updateCurrentSong();
            addToHistory(song);
            qDebug() << "[AudioEngine::play] æ–°æ­Œæ›²æ’­æ”¾å·²å¯åŠ¨";
            return;
        }
        
        // å…¶ä»–çŠ¶æ€çš„å¤„ç†
        qDebug() << "[AudioEngine::play] å…¶ä»–çŠ¶æ€ï¼Œå°è¯•æ’­æ”¾";
        m_player->play();
        m_state = AudioTypes::AudioState::Playing;
        m_userPaused = false;
        emit stateChanged(m_state);
        
        if (m_positionTimer) {
            m_positionTimer->start();
        }
        
    } catch (const std::exception& e) {
        QString errorMsg = QString("æ’­æ”¾å¤±è´¥: %1").arg(e.what());
        qDebug() << "[AudioEngine::play] æ’­æ”¾å¤±è´¥:" << errorMsg;
        logError(errorMsg);
        QMutexLocker locker(&m_mutex);
        m_state = AudioTypes::AudioState::Error;
        emit stateChanged(AudioTypes::AudioState::Error);
        emit errorOccurred(errorMsg);
    }
}
```

#### æš‚åœæ–¹æ³•å®ç°
```cpp
void AudioEngine::pause()
{
    qDebug() << "[AudioEngine::pause] å¼€å§‹æ‰§è¡Œæš‚åœæ–¹æ³•";
    
    if (!m_player) {
        qDebug() << "[AudioEngine::pause] é”™è¯¯ï¼šæ’­æ”¾å™¨æœªåˆå§‹åŒ–";
        logError("æ’­æ”¾å™¨æœªåˆå§‹åŒ–");
        return;
    }
    
    try {
        QMutexLocker locker(&m_mutex);
        
        QMediaPlayer::PlaybackState playerState = m_player->playbackState();
        qDebug() << "[AudioEngine::pause] å½“å‰QMediaPlayerçŠ¶æ€:" << playerState;
        
        // æ”¹è¿›çš„æš‚åœé€»è¾‘ï¼šåªè¦ä¸æ˜¯å·²æš‚åœçŠ¶æ€ï¼Œéƒ½å¯ä»¥å°è¯•æš‚åœ
        if (playerState != QMediaPlayer::PausedState) {
            qDebug() << "[AudioEngine::pause] è°ƒç”¨m_player->pause()";
            m_player->pause();
            
            qDebug() << "[AudioEngine::pause] æ›´æ–°çŠ¶æ€ä¸ºæš‚åœ";
            m_state = AudioTypes::AudioState::Paused;
            m_userPaused = true;
            
            qDebug() << "[AudioEngine::pause] å‘é€çŠ¶æ€å˜åŒ–ä¿¡å·";
            emit stateChanged(m_state);
            
            if (m_positionTimer) {
                m_positionTimer->stop();
                qDebug() << "[AudioEngine::pause] ä½ç½®æ›´æ–°å®šæ—¶å™¨å·²åœæ­¢";
            }
            
            logPlaybackEvent("æš‚åœæ’­æ”¾", currentSong().title());
            qDebug() << "[AudioEngine::pause] æš‚åœæ“ä½œå®Œæˆ";
        } else {
            qDebug() << "[AudioEngine::pause] å½“å‰å·²ç»æ˜¯æš‚åœçŠ¶æ€ï¼Œæ— éœ€é‡å¤æš‚åœ";
        }
        
    } catch (const std::exception& e) {
        qDebug() << "[AudioEngine::pause] æš‚åœå¤±è´¥:" << e.what();
        logError(QString("æš‚åœå¤±è´¥: %1").arg(e.what()));
    }
}
```

### 3. çŠ¶æ€ç®¡ç†ä¼˜åŒ–

#### çŠ¶æ€è½¬æ¢é€»è¾‘
```cpp
void AudioEngine::handlePlaybackStateChanged(QMediaPlayer::PlaybackState state)
{
    qDebug() << "[AudioEngine::handlePlaybackStateChanged] QMediaPlayerçŠ¶æ€å˜åŒ–:" << state;
    
    QMutexLocker locker(&m_mutex);
    
    AudioTypes::AudioState newState = convertMediaState(state);
    
    if (m_state != newState) {
        qDebug() << "[AudioEngine::handlePlaybackStateChanged] çŠ¶æ€ä»" << static_cast<int>(m_state) 
                 << "å˜ä¸º" << static_cast<int>(newState);
        
        m_state = newState;
        emit stateChanged(m_state);
    }
    
    emit playbackStateChanged(static_cast<int>(state));
}
```

#### çŠ¶æ€è½¬æ¢æ˜ å°„
```cpp
AudioTypes::AudioState AudioEngine::convertMediaState(QMediaPlayer::PlaybackState state) const
{
    switch (state) {
        case QMediaPlayer::PlayingState:
            return AudioTypes::AudioState::Playing;
        case QMediaPlayer::PausedState:
            return AudioTypes::AudioState::Paused;
        case QMediaPlayer::StoppedState:
            return AudioTypes::AudioState::Paused; // æ”¹ä¸ºæš‚åœçŠ¶æ€è€Œä¸æ˜¯åœæ­¢çŠ¶æ€
        default:
            return AudioTypes::AudioState::Paused;
    }
}
```

### 4. è°ƒè¯•ä¿¡æ¯å¢å¼º

#### è°ƒè¯•æ–¹æ³•å®ç°
```cpp
void AudioEngine::debugAudioState() const
{
    qDebug() << "=== AudioEngine çŠ¶æ€è°ƒè¯•ä¿¡æ¯ ===";
    qDebug() << "å½“å‰çŠ¶æ€:" << static_cast<int>(m_state);
    qDebug() << "æ’­æ”¾åˆ—è¡¨å¤§å°:" << m_playlist.size();
    qDebug() << "å½“å‰ç´¢å¼•:" << m_currentIndex;
    qDebug() << "å½“å‰ä½ç½®:" << m_position << "ms";
    qDebug() << "æ€»æ—¶é•¿:" << m_duration << "ms";
    qDebug() << "éŸ³é‡:" << m_volume;
    qDebug() << "é™éŸ³:" << m_muted;
    qDebug() << "ç”¨æˆ·æš‚åœ:" << m_userPaused;
    
    if (m_currentIndex >= 0 && m_currentIndex < m_playlist.size()) {
        Song currentSong = m_playlist[m_currentIndex];
        qDebug() << "å½“å‰æ­Œæ›²:" << currentSong.title() << "-" << currentSong.artist();
        qDebug() << "æ–‡ä»¶è·¯å¾„:" << currentSong.filePath();
        qDebug() << "æ–‡ä»¶æœ‰æ•ˆ:" << currentSong.isValid();
    } else {
        qDebug() << "å½“å‰æ­Œæ›²: æ— ";
    }
    
    if (m_player) {
        qDebug() << "QMediaPlayerçŠ¶æ€:" << m_player->playbackState();
        qDebug() << "QMediaPlayeråª’ä½“çŠ¶æ€:" << m_player->mediaStatus();
        qDebug() << "QMediaPlayeré”™è¯¯:" << m_player->error();
    } else {
        qDebug() << "QMediaPlayer: æœªåˆå§‹åŒ–";
    }
    
    if (m_audioOutput) {
        qDebug() << "QAudioOutputéŸ³é‡:" << m_audioOutput->volume();
        qDebug() << "QAudioOutputé™éŸ³:" << m_audioOutput->isMuted();
    } else {
        qDebug() << "QAudioOutput: æœªåˆå§‹åŒ–";
    }
    
    qDebug() << "=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===";
}
```

## ğŸ¯ æŠ€æœ¯ç‰¹ç‚¹

### 1. çº¿ç¨‹å®‰å…¨
- ä½¿ç”¨`QMutexLocker`ç¡®ä¿éŸ³é¢‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨
- éµå¾ªQtçš„ä¿¡å·æ§½æœºåˆ¶ï¼Œç¡®ä¿UIçº¿ç¨‹å’ŒéŸ³é¢‘çº¿ç¨‹çš„å®‰å…¨äº¤äº’

### 2. é”™è¯¯å¤„ç†
- å®Œå–„çš„ç©ºæŒ‡é’ˆæ£€æŸ¥å’ŒçŠ¶æ€éªŒè¯
- å¼‚å¸¸æ•è·å’Œé”™è¯¯æ—¥å¿—è®°å½•
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 3. è°ƒè¯•å‹å¥½
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºé—®é¢˜å®šä½
- çŠ¶æ€è°ƒè¯•æ–¹æ³•ï¼Œå¯éšæ—¶æŸ¥çœ‹éŸ³é¢‘å¼•æ“çŠ¶æ€
- å…³é”®æ“ä½œçš„è°ƒè¯•ä¿¡æ¯è®°å½•

### 4. æ¶æ„æ¸…æ™°
- ä¿æŒMVCæ¨¡å¼çš„æ¸…æ™°åˆ†å±‚
- å•ä¾‹æ¨¡å¼çš„æ­£ç¡®å®ç°
- ä¿¡å·æ§½æœºåˆ¶çš„åˆç†ä½¿ç”¨

## ğŸ“Š ä¿®å¤æ•ˆæœ

### 1. æ’­æ”¾æ§åˆ¶
- âœ… æ’­æ”¾æŒ‰é’®æ­£ç¡®å“åº”ç‚¹å‡»äº‹ä»¶
- âœ… æ’­æ”¾/æš‚åœçŠ¶æ€æ­£ç¡®åˆ‡æ¢
- âœ… æ’­æ”¾åˆ—è¡¨éªŒè¯å®Œå–„

### 2. çŠ¶æ€ç®¡ç†
- âœ… éŸ³é¢‘å¼•æ“çŠ¶æ€è½¬æ¢é€»è¾‘æ¸…æ™°
- âœ… çŠ¶æ€åŒæ­¥æœºåˆ¶å¯é 
- âœ… é”™è¯¯çŠ¶æ€å¤„ç†å®Œå–„

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… æ“ä½œå“åº”åŠæ—¶
- âœ… é”™è¯¯æç¤ºå‹å¥½
- âœ… è°ƒè¯•ä¿¡æ¯ä¸°å¯Œ

## ğŸ” å…³é”®æ”¹è¿›ç‚¹

1. **ç§»é™¤é‡å¤ä¿¡å·è¿æ¥**ï¼šç¡®ä¿æ’­æ”¾æ§åˆ¶æŒ‰é’®åªè¿æ¥åˆ°ä¸€ä¸ªå¤„ç†å‡½æ•°
2. **å¢å¼ºçŠ¶æ€æ£€æŸ¥**ï¼šåœ¨æ’­æ”¾å‰éªŒè¯æ’­æ”¾åˆ—è¡¨å’Œå½“å‰ç´¢å¼•çš„æœ‰æ•ˆæ€§
3. **å®Œå–„é”™è¯¯å¤„ç†**ï¼šæ·»åŠ å¼‚å¸¸æ•è·å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
4. **ä¼˜åŒ–è°ƒè¯•ä¿¡æ¯**ï¼šæä¾›è¯¦ç»†çš„çŠ¶æ€è°ƒè¯•æ–¹æ³•
5. **æ”¹è¿›çŠ¶æ€ç®¡ç†**ï¼šç»Ÿä¸€çŠ¶æ€è½¬æ¢é€»è¾‘ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´

è¿™äº›ä¿®æ”¹ç¡®ä¿äº†æ’­æ”¾æŒ‰é’®èƒ½å¤Ÿæ­£ç¡®å“åº”ç”¨æˆ·æ“ä½œï¼Œæä¾›äº†ç¨³å®šçš„æ’­æ”¾æ§åˆ¶ä½“éªŒã€‚
        