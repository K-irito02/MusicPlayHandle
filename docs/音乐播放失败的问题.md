# AudioEngine 崩溃问题修复说明

## 问题分析

经过代码审查，发现了导致播放按钮点击后界面卡顿和程序崩溃的几个关键问题：

### 1. 单例模式实现不一致
**问题**：`AudioEngine::instance()` 方法使用了局部静态变量 `s_instance`，但头文件中声明了类静态成员 `m_instance`，导致内存管理混乱。

**修复**：统一使用类静态成员 `m_instance` 并添加互斥锁保护。

### 2. play() 方法中的死锁风险
**问题**：
- 重复的索引检查（锁外和锁内都检查）
- 长时间持有互斥锁导致界面卡顿
- 异常处理中状态修改未加锁保护

**修复**：
- 移除重复检查，优化锁的使用范围
- 使用局部锁作用域，避免长时间持有锁
- 为异常处理添加适当的锁保护

### 3. onMediaStatusChanged() 方法线程安全问题
**问题**：状态检查和修改操作未加锁保护，可能导致竞态条件。

**修复**：添加互斥锁保护状态的检查和修改操作。

## 修复内容

### 1. 修复单例模式 (audioengine.cpp:54-64)
```cpp
AudioEngine* AudioEngine::instance()
{
    QMutexLocker locker(&m_instanceMutex);
    if (!m_instance) {
        m_instance = new AudioEngine();
        qDebug() << "[排查] AudioEngine::instance() 创建单例:" << m_instance;
    } else {
        qDebug() << "[排查] AudioEngine::instance() 返回已存在单例:" << m_instance;
    }
    return m_instance;
}
```

### 2. 重构 play() 方法
- 移除重复的索引检查
- 优化互斥锁使用，避免长时间持有
- 分离暂停恢复和新歌播放逻辑
- 改进异常处理的线程安全性

### 3. 修复 onMediaStatusChanged() 方法
- 添加互斥锁保护状态检查和修改
- 增加状态验证逻辑

## 测试建议

### 1. 添加测试音频文件
在项目目录下创建 `test_audio` 文件夹，并添加一些测试音频文件：
```
musicPlayHandle/
├── test_audio/
│   ├── test1.mp3
│   ├── test2.wav
│   └── test3.flac
```

### 2. 通过UI添加歌曲
1. 启动应用程序
2. 点击"添加歌曲"按钮
3. 选择音频文件添加到播放列表
4. 测试播放功能

### 3. 验证修复效果
- 界面应该不再卡顿
- 程序不应该崩溃
- 播放控制应该正常响应
- 日志输出应该显示正常的播放流程

## 预期改进

1. **消除界面卡顿**：通过优化锁的使用范围，避免长时间阻塞UI线程
2. **防止程序崩溃**：修复单例模式和线程安全问题
3. **提高稳定性**：改进错误处理和状态管理
4. **保持响应性**：确保UI操作能够及时响应

## 注意事项

1. 确保有可用的音频文件进行测试
2. 观察控制台日志输出，了解播放流程
3. 如果仍有问题，请提供具体的错误信息和日志